<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Trudesk &middot; Documentation</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"Trudesk","disqus":"","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"Trudesk &middot; Documentation","description":"","keyword":""},"linenums":true};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">Trudesk</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="apiController">
            <span class="title">
                <a href="apiController.html">apiController</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="apiController.index"><a href="apiController.html#.index">index</a></li>
            
                <li data-name="apiController.login"><a href="apiController.html#.login">login</a></li>
            
                <li data-name="apiController.logout"><a href="apiController.html#.logout">logout</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="apiController.devices">
            <span class="title">
                <a href="apiController.devices.html">apiController.devices</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="apiController.devices.setDeviceToken"><a href="apiController.devices.html#.setDeviceToken">setDeviceToken</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="apiController.groups">
            <span class="title">
                <a href="apiController.groups.html">apiController.groups</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="apiController.groups.create"><a href="apiController.groups.html#.create">create</a></li>
            
                <li data-name="apiController.groups.deleteGroup"><a href="apiController.groups.html#.deleteGroup">deleteGroup</a></li>
            
                <li data-name="apiController.groups.get"><a href="apiController.groups.html#.get">get</a></li>
            
                <li data-name="apiController.groups.updateGroup"><a href="apiController.groups.html#.updateGroup">updateGroup</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="apiController.messsages">
            <span class="title">
                <a href="apiController.messsages.html">apiController.messsages</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="apiController.roles">
            <span class="title">
                <a href="apiController.roles.html">apiController.roles</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="apiController.tickets">
            <span class="title">
                <a href="apiController.tickets.html">apiController.tickets</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="apiController.users">
            <span class="title">
                <a href="apiController.users.html">apiController.users</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="apiController.users.deleteUser"><a href="apiController.users.html#.deleteUser">deleteUser</a></li>
            
                <li data-name="apiController.users.get"><a href="apiController.users.html#.get">get</a></li>
            
                <li data-name="apiController.users.insert"><a href="apiController.users.html#.insert">insert</a></li>
            
                <li data-name="apiController.users.notificationCount"><a href="apiController.users.html#.notificationCount">notificationCount</a></li>
            
                <li data-name="apiController.users.single"><a href="apiController.users.html#.single">single</a></li>
            
                <li data-name="apiController.users.update"><a href="apiController.users.html#.update">update</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="ticketsController">
            <span class="title">
                <a href="ticketsController.html">ticketsController</a>
                
                <span class="static">static</span>
                
            </span>
            <ul class="members itemMembers">
            
            <span class="subtitle">Members</span>
            
                <li data-name="ticketsController.content"><a href="ticketsController.html#.content">content</a></li>
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="ticketsController.create"><a href="ticketsController.html#.create">create</a></li>
            
                <li data-name="ticketsController.editTicket"><a href="ticketsController.html#.editTicket">editTicket</a></li>
            
                <li data-name="ticketsController.get"><a href="ticketsController.html#.get">get</a></li>
            
                <li data-name="ticketsController.getActive"><a href="ticketsController.html#.getActive">getActive</a></li>
            
                <li data-name="ticketsController.getAssigned"><a href="ticketsController.html#.getAssigned">getAssigned</a></li>
            
                <li data-name="ticketsController.getByStatus"><a href="ticketsController.html#.getByStatus">getByStatus</a></li>
            
                <li data-name="ticketsController.print"><a href="ticketsController.html#.print">print</a></li>
            
                <li data-name="ticketsController.single"><a href="ticketsController.html#.single">single</a></li>
            
                <li data-name="ticketsController#getPriorityName"><a href="ticketsController.html#getPriorityName">getPriorityName</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Group">
            <span class="title">
                <a href="Group.html">Group</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Group.getGroupByName"><a href="Group.html#.getGroupByName">getGroupByName</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Report">
            <span class="title">
                <a href="Report.html">Report</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Report.getReports"><a href="Report.html#.getReports">getReports</a></li>
            
                <li data-name="Report.getRunnableReports"><a href="Report.html#.getRunnableReports">getRunnableReports</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="Ticket">
            <span class="title">
                <a href="Ticket.html">Ticket</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="Ticket.getAll"><a href="Ticket.html#.getAll">getAll</a></li>
            
                <li data-name="Ticket.getComments"><a href="Ticket.html#.getComments">getComments</a></li>
            
                <li data-name="Ticket.getDateCount"><a href="Ticket.html#.getDateCount">getDateCount</a></li>
            
                <li data-name="Ticket.getMonthCount"><a href="Ticket.html#.getMonthCount">getMonthCount</a></li>
            
                <li data-name="Ticket.getStatusCount"><a href="Ticket.html#.getStatusCount">getStatusCount</a></li>
            
                <li data-name="Ticket.getStatusCountByDate"><a href="Ticket.html#.getStatusCountByDate">getStatusCountByDate</a></li>
            
                <li data-name="Ticket.getTicketById"><a href="Ticket.html#.getTicketById">getTicketById</a></li>
            
                <li data-name="Ticket.getTicketByUid"><a href="Ticket.html#.getTicketByUid">getTicketByUid</a></li>
            
                <li data-name="Ticket.getTickets"><a href="Ticket.html#.getTickets">getTickets</a></li>
            
                <li data-name="Ticket.getTicketsByStatus"><a href="Ticket.html#.getTicketsByStatus">getTicketsByStatus</a></li>
            
                <li data-name="Ticket.getTicketsWithLimit"><a href="Ticket.html#.getTicketsWithLimit">getTicketsWithLimit</a></li>
            
                <li data-name="Ticket.getTicketsWithObject"><a href="Ticket.html#.getTicketsWithObject">getTicketsWithObject</a></li>
            
                <li data-name="Ticket.getTotalCount"><a href="Ticket.html#.getTotalCount">getTotalCount</a></li>
            
                <li data-name="Ticket.getTotalMonthCount"><a href="Ticket.html#.getTotalMonthCount">getTotalMonthCount</a></li>
            
                <li data-name="Ticket.getYearCount"><a href="Ticket.html#.getYearCount">getYearCount</a></li>
            
                <li data-name="Ticket.softDelete"><a href="Ticket.html#.softDelete">softDelete</a></li>
            
                <li data-name="Ticket#clearAssignee"><a href="Ticket.html#clearAssignee">clearAssignee</a></li>
            
                <li data-name="Ticket#removeComment"><a href="Ticket.html#removeComment">removeComment</a></li>
            
                <li data-name="Ticket#setAssignee"><a href="Ticket.html#setAssignee">setAssignee</a></li>
            
                <li data-name="Ticket#setIssue"><a href="Ticket.html#setIssue">setIssue</a></li>
            
                <li data-name="Ticket#setStatus"><a href="Ticket.html#setStatus">setStatus</a></li>
            
                <li data-name="Ticket#setTicketGroup"><a href="Ticket.html#setTicketGroup">setTicketGroup</a></li>
            
                <li data-name="Ticket#setTicketPriority"><a href="Ticket.html#setTicketPriority">setTicketPriority</a></li>
            
                <li data-name="Ticket#setTicketType"><a href="Ticket.html#setTicketType">setTicketType</a></li>
            
                <li data-name="Ticket#updateComment"><a href="Ticket.html#updateComment">updateComment</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="TicketType">
            <span class="title">
                <a href="TicketType.html">TicketType</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="TicketType.getTypeByName"><a href="TicketType.html#.getTypeByName">getTypeByName</a></li>
            
                <li data-name="TicketType.getTypes"><a href="TicketType.html#.getTypes">getTypes</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="User">
            <span class="title">
                <a href="User.html">User</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="User.findAll"><a href="User.html#.findAll">findAll</a></li>
            
                <li data-name="User.getAssigneeUsers"><a href="User.html#.getAssigneeUsers">getAssigneeUsers</a></li>
            
                <li data-name="User.getUser"><a href="User.html#.getUser">getUser</a></li>
            
                <li data-name="User.getUserByAccessToken"><a href="User.html#.getUserByAccessToken">getUserByAccessToken</a></li>
            
                <li data-name="User.getUserByEmail"><a href="User.html#.getUserByEmail">getUserByEmail</a></li>
            
                <li data-name="User.getUserByResetHash"><a href="User.html#.getUserByResetHash">getUserByResetHash</a></li>
            
                <li data-name="User.getUserByUsername"><a href="User.html#.getUserByUsername">getUserByUsername</a></li>
            
                <li data-name="User.insertUser"><a href="User.html#.insertUser">insertUser</a></li>
            
                <li data-name="User#hasAccessToken"><a href="User.html#hasAccessToken">hasAccessToken</a></li>
            
                <li data-name="User#hasDeviceToken"><a href="User.html#hasDeviceToken">hasDeviceToken</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="models_report.js.html">Source: models/report.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
      .                              .o8                     oooo
   .o8                             "888                     `888
 .o888oo oooo d8b oooo  oooo   .oooo888   .ooooo.   .oooo.o  888  oooo
   888   `888""8P `888  `888  d88' `888  d88' `88b d88(  "8  888 .8P'
   888    888      888   888  888   888  888ooo888 `"Y88b.   888888.
   888 .  888      888   888  888   888  888    .o o.  )88b  888 `88b.
   "888" d888b     `V88V"V8P' `Y8bod88P" `Y8bod8P' 8""888P' o888o o888o
 ========================================================================
 */

var mongoose        = require('mongoose');
var _               = require('underscore');
var deepPopulate    = require('mongoose-deep-populate');
var accountsSchema  = require('./user');
var groupSchema     = require('./group');

var COLLECTION = 'reports';

/**
 * @since 1.0
 * @author Chris Brame &lt;polonel@gmail.com>
 * @copyright 2015 Chris Brame
 **/

/**
 * Report Object Schema for MongoDB
 * @module models/report
 * @class Report
 * @property {Number} uid ```Required``` ```unique``` Readable ID of the report
 * @property {String} name ```Required``` Name of the report
 * @property {Number} type ```Required``` Report Type
 * @property {Date} runDate ```Required``` [default:Date.now] Date the Report was ran.
 * @property {Boolean} recurring ```Required``` [default:false] Is the report Recurring?
 * @property {Number} interval The interval the report should run. *Only when recurring.*
 * @property {Date} lastRun Last datetime the report was ran. *Only when recurring.*
 * @property {Number} status ```Required``` [default:0] Status of report.
 * @property {Array} data ```Required``` Data for the given report. *Based on report type*
 */
var reportSchema = mongoose.Schema({
    uid:        { type: Number, required: true, unique: true },
    name:       { type: String, required: true },
    type:       { type: Number, required: true },
    runDate:    { type: Date, required: true, default: Date.now },
    recurring:  { type: Boolean, required: true, default: false },
    interval:   { type: Number },
    lastRun:    { type: Date },
    status:     { type: Number, required: true, default: 0},
    data:       { type: [mongoose.Schema.Types.Mixed], required: true}
});

reportSchema.plugin(deepPopulate);

reportSchema.pre('save', function(next) {
    if (!_.isUndefined(this.uid) || this.uid) return next();

    var c = require('./counters');
    var self = this;
    c.increment('reports', function(err, res, k) {
        if (err) return next(err);

        self.uid = res.value.next;

        if (_.isUndefined(self.uid)) {
            var error = new Error('Invalid UID.');
            return next(error);
        }

        return next();
    });
});

/**
 * Get All Reports
 *
 * @method getReports
 * @memberof Report
 * @param {QueryCallback} callback MongoDB Query Callback
 */
reportSchema.statics.getReports = function(callback) {
    return this.model(COLLECTION).find({}).exec(callback);
};

/**
 * Get only Runnable Reports
 *
 * @method getRunnableReports
 * @memberof Report
 * @param {QueryCallback} callback MongoDB Query Callback
 */
reportSchema.statics.getRunnableReports = function(callback) {
    var reports = [];
    var q = this.model(COLLECTION).find({status: 0});

    q.exec(function(err, items) {
        if (err) return callback(err);
        _.each(items, function(item) {
            if (!item.recurring) {
                reports.push(item);
            } else {
                var now = Date.now();
                var nextrun = new Date(now + item.interval);
                if (now >= nextrun)
                    reports.push(item);
            }
        });

        callback(null, reports);
    });
};

reportSchema.statics.getReportByType = function(type, callback) {
    if (_.isUndefined(type) || _.isNull(type)) return callback("Invalid Report Type - ReportSchema.GetReportByType();", null);

    return this.model(COLLECTION).find({type: type}).exec(callback);
};

reportSchema.statics.getReportByStatus = function(status, callback) {
    if (_.isUndefined(status) || _.isNull(status)) return callback("Invalid Report Status - ReportSchema.GetReportByStatus();", null);

    return this.model(COLLECTION).find({status: status}).exec(callback);
};

module.exports = mongoose.model(COLLECTION, reportSchema);</code></pre>
        </article>
    </section>






        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Wed Jul 22 2015 23:25:39 GMT-0400 (Eastern Daylight Time)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
